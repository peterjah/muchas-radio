services:
  # MPD - Music Player Daemon
  mpd:
    build:
      context: ./mpd
      dockerfile: Dockerfile
    container_name: muchas-mpd
    restart: unless-stopped
    ports:
      - "6600:6600"  # MPD control port
      - "8001:8001"  # HTTP stream port (low quality - 128 kbps)
      - "8002:8002"  # HTTP stream port (medium quality - 192 kbps)
      - "8003:8003"  # HTTP stream port (high quality - 320 kbps)
    volumes:
      - mpd-data:/var/lib/mpd
      - music-uploads:/music
    networks:
      - muchas-network
    healthcheck:
      test: ["CMD", "mpc", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Backend - Rust API server
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: muchas-backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - MPD_HOST=mpd
      - MPD_PORT=6600
      - BIND_ADDR=0.0.0.0:8080
      - RUST_LOG=info
      - MAX_TOTAL_STORAGE=${MAX_TOTAL_STORAGE:-300MB}
    volumes:
      - music-uploads:/app/uploads
      - backend-data:/app/data
    depends_on:
      - mpd
    networks:
      - muchas-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/current"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend - React PWA
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Use empty strings for relative URLs (same origin) - automatically uses HTTPS/WSS when served over HTTPS
        # Or set to absolute URLs like https://muchasradio.com and wss://muchasradio.com
        VITE_API_URL: ${VITE_API_URL:-}
        VITE_WS_URL: ${VITE_WS_URL:-}
    container_name: muchas-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - muchas-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx - Reverse proxy (optional, combines everything on port 80)
  nginx:
    image: nginx:alpine
    container_name: muchas-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - certbot-www:/var/www/certbot:ro
      - certbot-conf:/etc/letsencrypt:ro
    depends_on:
      - frontend
      - backend
    networks:
      - muchas-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Certbot - SSL certificate management (runs in background for auto-renewal)
  certbot:
    image: certbot/certbot:latest
    container_name: muchas-certbot
    volumes:
      - certbot-www:/var/www/certbot
      - certbot-conf:/etc/letsencrypt
    networks:
      - muchas-network
    # Only start this container after initial certificates are obtained
    # For one-off certbot commands, use: docker compose run --rm --entrypoint="" certbot certbot ...
    profiles:
      - ssl-renewal
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  mpd-data:
    driver: local
  # Music storage: uses bind mount to host directory for easy access
  # Default: ./data/music (relative to docker-compose.yml)
  # Override with MUSIC_STORAGE_PATH environment variable
  music-uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MUSIC_STORAGE_PATH:-./data/music}
  backend-data:
    driver: local
  certbot-www:
    driver: local
  certbot-conf:
    driver: local

networks:
  muchas-network:
    driver: bridge

