version: '3.8'

services:
  # MPD - Music Player Daemon
  mpd:
    build:
      context: ./mpd
      dockerfile: Dockerfile
    container_name: muchas-mpd
    restart: unless-stopped
    ports:
      - "6600:6600"  # MPD control port
      - "8001:8001"  # HTTP stream port
    volumes:
      - mpd-data:/var/lib/mpd
      - music-uploads:/music
      - playlists:/playlists
    networks:
      - muchas-network
    healthcheck:
      test: ["CMD", "mpc", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Backend - Rust API server
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: muchas-backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - MPD_HOST=mpd
      - MPD_PORT=6600
      - MPD_BASE_DIR=/app/data
      - MPD_MUSIC_DIR=/app/uploads
      - MPD_PLAYLIST_DIR=/app/playlists
      - MPD_BIND_ADDRESS=0.0.0.0
      - BIND_ADDR=0.0.0.0:8080
      - RUST_LOG=info
    volumes:
      - music-uploads:/app/uploads
      - playlists:/app/playlists
      - backend-data:/app/data
    depends_on:
      - mpd
    networks:
      - muchas-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/current"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend - React PWA
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8080}
        VITE_WS_URL: ${VITE_WS_URL:-ws://localhost:8080}
    container_name: muchas-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - muchas-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx - Reverse proxy (optional, combines everything on port 80)
  nginx:
    image: nginx:alpine
    container_name: muchas-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - frontend
      - backend
    networks:
      - muchas-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mpd-data:
    driver: local
  music-uploads:
    driver: local
  playlists:
    driver: local
  backend-data:
    driver: local

networks:
  muchas-network:
    driver: bridge

